<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/sss-module.umd.min.js"></script>
  <script type="module">
    // Symbol SDKを動的にインポート
    let sdk, sdkCore, symbolSdk;
    let sdkLoaded = false;

    import('https://www.unpkg.com/symbol-sdk@3.2.3/dist/bundle.web.js')
      .then(loadedSdk => {
        sdk = loadedSdk;
        sdkCore = loadedSdk.core;
        symbolSdk = loadedSdk.symbol;
        sdkLoaded = true;
        console.log('Symbol SDK loaded successfully');

        // SDKが読み込まれたことを他のスクリプトに通知
        document.dispatchEvent(new CustomEvent('sdkLoaded', {
          detail: { sdk, sdkCore, symbolSdk }
        }));
      })
      .catch(error => {
        console.error('Failed to load Symbol SDK:', error);
        document.dispatchEvent(new CustomEvent('sdkError', { detail: error }));
      });

    // SDKアクセス用のAPI
    document.addEventListener('sdkRequest', (event) => {
      const { callback } = event.detail;
      if (sdkLoaded && callback) {
        callback({ sdk, sdkCore, symbolSdk, loaded: sdkLoaded });
      } else {
        callback({ sdk: null, sdkCore: null, symbolSdk: null, loaded: false });
      }
    });
  </script>
  <title>Symbol Sign On Authorization</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }

    .app-info {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #007bff;
    }

    .challenge-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border: 1px solid #ddd;
    }

    button {
      background: #007bff;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
      min-width: 120px;
    }

    button:hover {
      background: #0056b3;
    }

    .deny-btn {
      background: #dc3545;
    }

    .deny-btn:hover {
      background: #c82333;
    }

    .button-group {
      text-align: center;
      margin-top: 30px;
    }

    .challenge-id {
      font-family: monospace;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
      word-break: break-all;
    }

    .info-text {
      color: #666;
      font-size: 14px;
      margin: 10px 0;
    }

    .loading {
      color: #666;
      font-style: italic;
    }

    .error {
      color: #dc3545;
      background: #f8d7da;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>認可リクエスト</h2>

    <div class="app-info">
      <strong>アプリケーション:</strong> {{CLIENT_ID}}<br>
      <strong>リダイレクト URI:</strong> {{REDIRECT_URI}}
      {{SCOPE_INFO}}
    </div>

    <p>上記のアプリケーションがあなたのSymbolアカウントへのアクセスを要求しています。</p>

    <div class="challenge-info">
      <strong>チャレンジ ID:</strong>
      <div class="challenge-id">{{CHALLENGE}}</div>
      <div class="info-text">
        ※ この認可を完了するには、別途 /oauth/verify-signature エンドポイントで
        署名検証を行う必要があります。
      </div>
    </div>

    <div class="button-group">
      <button onclick="authorize()">認可する</button>
      <button class="deny-btn" onclick="deny()">拒否する</button>
    </div>

    <div id="result"></div>
    <div id="sdk-status" class="loading">Symbol SDK読み込み中...</div>
  </div>

  <script>
    let currentSDK = null;

    // SDKの読み込み状態を監視
    document.addEventListener('sdkLoaded', (event) => {
      currentSDK = event.detail;
      document.getElementById('sdk-status').innerHTML =
        '<div style="color: #28a745;">Symbol SDK読み込み完了</div>';
    });

    document.addEventListener('sdkError', (event) => {
      document.getElementById('sdk-status').innerHTML =
        '<div class="error">Symbol SDK読み込みエラー: ' + event.detail.message + '</div>';
    });

    // SDKへのアクセス関数
    function getSDK() {
      return new Promise((resolve) => {
        if (currentSDK) {
          resolve(currentSDK);
        } else {
          document.dispatchEvent(new CustomEvent('sdkRequest', {
            detail: {
              callback: resolve
            }
          }));
        }
      });
    }

    async function createTransaction(userPublicKeyString) {
      try {
        const { symbolSdk } = await getSDK();

        if (!symbolSdk) {
          throw new Error('Symbol SDK not available');
        }

        // ダミーアカウント（無効な公開鍵）
        const invalidPublicKey = new symbolSdk.PublicKey(
          "0000000000000000000000000000000000000000000000000000000000000000"
        );
        const dummyAccount = symbolSdk.facade.createPublicAccount(invalidPublicKey);

        // ユーザーアカウント
        const userAccount = symbolSdk.facade.createPublicAccount(
          new symbolSdk.PublicKey(userPublicKeyString)
        );

        // メッセージ
        const message = '\0{{CHALLENGE}}'

        // トランザクション生成
        const transferDescriptor = new descriptors.TransferTransactionV1Descriptor(
          dummyAccount.address,
          [],
          message,
        );
        const transferTx = facade.createTransactionFromTypedDescriptor(
          transferDescriptor,
          userAccount.publicKey,
          10,
          0,
          0,
        );
        return transferTx;
      } catch (error) {
        console.error('Transaction creation failed:', error);
        return null;
      }
    }

    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    async function authorize() {
      try {
        const { symbolSdk, loaded } = await getSDK();

        if (!loaded) {
          alert('Symbol SDK is still loading. Please wait a moment and try again.');
          return;
        }

        if (isMobileDevice()) {
          // スマートフォンの場合はSSSモジュールをリクエスト
          console.log('スマートフォンデバイスを検出しました。aLiceをリクエストします。');
        } else {
          // PCの場合はSSSモジュールを直接使用
          console.log('ネットワーク: {{STATE_PARAM}}');

          const facade = new symbolSdk.SymbolFacade('testnet');

          if (SSSModule.requestSSS()) {
            const userPublicKey = SSSModule.getActivePublicKey();
            await createTransaction(userPublicKey);
          }
        }

        // デバイス判定
        const deviceType = isMobileDevice() ? 'スマートフォン' : 'PC';

        // 認可を承認 - チャレンジIDを返す
        // 実際のフローでは、クライアントが署名検証を行った後に認可コードを取得
        document.getElementById('result').innerHTML =
          '<div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0;">' +
          '認可が承認されました。チャレンジ ID: {{CHALLENGE}}<br>' +
          '{{STATE_PARAM}}<br>' +
          'デバイス: ' + deviceType + '<br>' +
          'クライアントアプリケーションで署名検証を行ってください。' +
          '</div>';
      } catch (error) {
        console.error('Authorization failed:', error);
        document.getElementById('result').innerHTML =
          '<div class="error">認可処理中にエラーが発生しました: ' + error.message + '</div>';
      }
    }

    function deny() {
      // OAuth2準拠: エラーをredirect_uriに返す
      const redirectUrl = new URL('{{REDIRECT_URI}}');
      redirectUrl.searchParams.set('error', 'access_denied');
      redirectUrl.searchParams.set('error_description', 'User denied authorization');
      window.location.href = redirectUrl.toString();

      // リダイレクト後にウィンドウを閉じる
      setTimeout(() => {
        window.close();
      }, 100);
    }
  </script>
</body>

</html>
