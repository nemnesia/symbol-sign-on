<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Symbol Sign On Demo</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <h1>Symbol Sign On 呼び出しデモ</h1>

    <!-- ボタン表示エリア -->
    <div class="button-container">
      <button id="redirect-login-get">ログイン画面へ(GET)</button>
    </div>
    <div class="button-container">
      <button id="redirect-login">ログイン画面へ(POST)</button>
    </div>
  </div>

  <script>
    // PKCEのcode_verifierとcode_challengeを生成する関数
    async function generatePKCE() {
      const codeVerifier = crypto.randomUUID();
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const codeChallenge = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return { codeVerifier, codeChallenge };
    }

    // リダイレクトパターンの処理
    document.getElementById('redirect-login-get').addEventListener('click', async function () {
      // クライアントID（Symbol Sign Onに登録が必要）
      const clientId = 'demo-app';

      // リダイレクトURI（Symbol Sign Onに登録が必要）
      const redirectUri = window.location.origin + window.location.pathname + 'callback.html';

      // ユニークな状態識別子を生成（リダイレクト後に検証するため）
      const state = crypto.randomUUID();
      console.debug('state:', state);

      // PKCEのcode_verifierとcode_challengeを生成
      const { codeVerifier, codeChallenge } = await generatePKCE();
      console.debug('PKCE code_verifier:', codeVerifier); // アクセストークン取得まで秘匿
      console.debug('PKCE code_challenge (SHA256ハッシュ):', codeChallenge); // 公開可能

      // パラメータをオブジェクトとして定義
      const params = {
        client_id: clientId,
        redirect_uri: redirectUri,
        state: state,
        code_challenge: codeChallenge,
        code_challenge_method: 'S256',
      };

      // またはGETリクエストを使用する場合
      const queryString = new URLSearchParams(params).toString();
      window.location.href = `http://localhost:3510/login.html?${queryString}`;
    });

        // リダイレクトパターンの処理
    document.getElementById('redirect-login').addEventListener('click', async function () {
      // クライアントID（Symbol Sign Onに登録が必要）
      const clientId = 'demo-app';

      // リダイレクトURI（Symbol Sign Onに登録が必要）
      const redirectUri = window.location.origin + window.location.pathname + 'callback.html';

      // ユニークな状態識別子を生成（リダイレクト後に検証するため）
      const state = crypto.randomUUID();
      console.debug('state:', state);

      // PKCEのcode_verifierとcode_challengeを生成
      const { codeVerifier, codeChallenge } = await generatePKCE();
      console.debug('PKCE code_verifier:', codeVerifier); // アクセストークン取得まで秘匿
      console.debug('PKCE code_challenge (SHA256ハッシュ):', codeChallenge); // 公開可能

      // パラメータをオブジェクトとして定義
      const params = {
        client_id: clientId,
        redirect_uri: redirectUri,
        state: state,
        code_challenge: codeChallenge,
        code_challenge_method: 'S256',
      };

      // 動的にフォームを作成してポップアップでPOSTリクエストを送信
      const width = 600;
      const height = 520;
      const left = (window.screen.availWidth - width) / 2;
      const top = (window.screen.availHeight - height) / 2;
      console.debug('Popup position - left:', left, 'top:', top);
      const popup = window.open('', '_blank', `width=${width},height=${height},left=${left},top=${top}`);
      const form = popup.document.createElement('form');
      form.method = 'POST';
      form.action = 'http://localhost:3510/login.html';
      Object.entries(params).forEach(([key, value]) => {
        const input = popup.document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
      });
      popup.document.body.appendChild(form);
      form.submit();

      // // またはGETリクエストを使用する場合
      // const queryString = new URLSearchParams(params).toString();
      // window.location.href = `http://localhost:3510/login.html?${queryString}`;
    });
  </script>
</body>

</html>
