<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Symbol Sign On Demo</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <h1>Symbol Sign On Demo</h1>

    <div class="button-container">
      <button id="redirect-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="error-message" class="error-message"></div>
  </div>

  <script>
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showError(error, description) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = `${error}: ${description}`;
      errorElement.style.display = 'block';
    }

    // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getCodeFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      if (code) {
        // ã‚³ãƒ¼ãƒ‰ãŒå–å¾—ã§ããŸå ´åˆã®å‡¦ç†
        console.log('èªå¯ã‚³ãƒ¼ãƒ‰å–å¾—æˆåŠŸ:', code);

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const successMessage = document.createElement('div');
        successMessage.id = 'auth-success-message';
        successMessage.style.color = '#27ae60';
        successMessage.style.padding = '15px';
        successMessage.style.margin = '15px 0';
        successMessage.style.borderRadius = '5px';
        successMessage.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
        successMessage.style.borderLeft = '4px solid #27ae60';
        successMessage.style.textAlign = 'left';
        successMessage.textContent = `èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸï¼èªå¯ã‚³ãƒ¼ãƒ‰: ${code}`;
        successMessage.setAttribute('data-auth-success', 'true'); // èªè¨¼æˆåŠŸã®ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 

        // æ—¢ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å‰Šé™¤
        const existingStatus = document.getElementById('popup-status');
        if (existingStatus) {
          existingStatus.remove();
        }

        document.querySelector('.container').appendChild(successMessage);

        // ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        fetchTokenWithCode(code);

        // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚ï¼‰
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã« URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ã‹ã‚‰ã®æˆ»ã‚Šï¼‰
    document.addEventListener('DOMContentLoaded', getCodeFromUrl);

    // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã«ä¿å­˜ã™ã‚‹é–¢æ•°
    function saveTokensToStorage(tokenData) {
      try {
        localStorage.setItem('access_token', tokenData.access_token);

        if (tokenData.refresh_token) {
          localStorage.setItem('refresh_token', tokenData.refresh_token);
        }

        // æœ‰åŠ¹æœŸé™ã‚’è¨ˆç®—ã—ã¦ä¿å­˜
        if (tokenData.expires_in) {
          const expiresAt = Date.now() + (tokenData.expires_in * 1000);
          localStorage.setItem('expires_at', expiresAt);
        }

        console.log('ãƒˆãƒ¼ã‚¯ãƒ³ãŒlocalStorageã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ');
      } catch (error) {
        console.error('ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœŸé™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
    function isAccessTokenExpired() {
      const expiresAt = localStorage.getItem('expires_at');

      if (!expiresAt) {
        return true; // æœ‰åŠ¹æœŸé™æƒ…å ±ãŒãªã„å ´åˆã¯æœŸé™åˆ‡ã‚Œã¨ã¿ãªã™
      }

      const now = Date.now();
      const expiration = parseInt(expiresAt);

      return now >= expiration;
    }

    // ãƒˆãƒ¼ã‚¯ãƒ³ã®æ®‹ã‚Šæ™‚é–“ã‚’è¨ˆç®—
    function getTokenTimeRemaining() {
      const expiresAt = localStorage.getItem('expires_at');

      if (!expiresAt) {
        return null;
      }

      const now = Date.now();
      const expiration = parseInt(expiresAt);
      const remaining = expiration - now;

      if (remaining <= 0) {
        return 0;
      }

      return Math.floor(remaining / 1000); // ç§’å˜ä½ã§è¿”ã™
    }

    // æœŸé™ãƒã‚§ãƒƒã‚¯çµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function checkAccessTokenExpiry() {
      const accessToken = localStorage.getItem('access_token');

      if (!accessToken) {
        return {
          status: 'no_token',
          message: 'ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
          color: '#e74c3c'
        };
      }

      const timeRemaining = getTokenTimeRemaining();

      if (timeRemaining === null) {
        return {
          status: 'no_expiry',
          message: 'æœ‰åŠ¹æœŸé™æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“',
          color: '#f39c12'
        };
      }

      if (timeRemaining <= 0) {
        return {
          status: 'expired',
          message: 'ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœŸé™åˆ‡ã‚Œã§ã™',
          color: '#e74c3c'
        };
      }

      // æ®‹ã‚Šæ™‚é–“ã‚’äººé–“ãŒèª­ã¿ã‚„ã™ã„å½¢å¼ã«å¤‰æ›
      const hours = Math.floor(timeRemaining / 3600);
      const minutes = Math.floor((timeRemaining % 3600) / 60);
      const seconds = timeRemaining % 60;

      let timeString = '';
      if (hours > 0) {
        timeString = `${hours}æ™‚é–“${minutes}åˆ†`;
      } else if (minutes > 0) {
        timeString = `${minutes}åˆ†${seconds}ç§’`;
      } else {
        timeString = `${seconds}ç§’`;
      }

      // 5åˆ†ä»¥å†…ãªã‚‰è­¦å‘Šè‰²
      const color = timeRemaining <= 300 ? '#f39c12' : '#27ae60';

      return {
        status: 'valid',
        message: `ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ‰åŠ¹ã§ã™ï¼ˆæ®‹ã‚Š: ${timeString}ï¼‰`,
        color: color,
        timeRemaining: timeRemaining
      };
    }

    // æœŸé™ãƒã‚§ãƒƒã‚¯çµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showTokenExpiryStatus() {
      const result = checkAccessTokenExpiry();

      // æ—¢å­˜ã®æœŸé™ãƒã‚§ãƒƒã‚¯çµæœãŒã‚ã‚Œã°å‰Šé™¤
      const existingResult = document.querySelector('[data-expiry-result]');
      if (existingResult) {
        existingResult.remove();
      }

      // çµæœã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ã‚’ä½œæˆ
      const expiryResult = document.createElement('div');
      expiryResult.style.marginTop = '15px';
      expiryResult.style.padding = '10px';
      expiryResult.style.borderRadius = '4px';
      expiryResult.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
      expiryResult.style.border = `2px solid ${result.color}`;
      expiryResult.style.color = result.color;
      expiryResult.style.fontWeight = 'bold';
      expiryResult.setAttribute('data-expiry-result', 'true');

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
      let icon = '';
      switch (result.status) {
        case 'valid':
          icon = 'âœ… ';
          break;
        case 'expired':
          icon = 'âŒ ';
          break;
        case 'no_token':
          icon = 'âš ï¸ ';
          break;
        case 'no_expiry':
          icon = 'âš ï¸ ';
          break;
      }

      expiryResult.innerHTML = `
        <div style="text-align: center;">
          ${icon}${result.message}
        </div>
      `;

      // æœŸé™ãŒè¿‘ã„å ´åˆã¯è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã®ææ¡ˆã‚’è¡¨ç¤º
      if (result.status === 'valid' && result.timeRemaining && result.timeRemaining <= 300) {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.style.marginTop = '8px';
        suggestionDiv.style.fontSize = '12px';
        suggestionDiv.style.color = '#666';
        suggestionDiv.style.textAlign = 'center';
        suggestionDiv.textContent = 'ğŸ’¡ æœŸé™ãŒè¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆã§æ›´æ–°ã§ãã¾ã™ã€‚';
        expiryResult.appendChild(suggestionDiv);
      }

      // ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠã«çµæœã‚’è¿½åŠ 
      const tokenInfo = document.querySelector('.container > div:last-child');
      if (tokenInfo) {
        tokenInfo.appendChild(expiryResult);
      }
    }

    // èªå¯ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    async function fetchTokenWithCode(code) {
      try {
        const response = await fetch('http://localhost:3510/oauth/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            grant_type: 'authorization_code',
            code: code,
            client_id: 'demo_app'
          })
        });

        const data = await response.json();
        if (response.ok) {
          console.log('ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ:', data);

          // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã«ä¿å­˜
          saveTokensToStorage(data);

          // å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¡¨ç¤º
          const tokenInfo = document.createElement('div');
          tokenInfo.style.marginTop = '20px';
          tokenInfo.style.padding = '15px';
          tokenInfo.style.backgroundColor = '#f8f9fa';
          tokenInfo.style.borderRadius = '5px';
          tokenInfo.style.textAlign = 'left';
          tokenInfo.innerHTML = `
            <h3>å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±:</h3>
            <pre style="overflow-x: auto; background: #eee; padding: 10px; border-radius: 4px;">${JSON.stringify(data, null, 2)}</pre>
            <p>â€» ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦ã€Symbol Sign On APIã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚</p>
          `;

          // ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
          const buttonContainer = document.createElement('div');
          buttonContainer.style.marginTop = '10px';
          buttonContainer.style.textAlign = 'center';
          buttonContainer.style.display = 'flex';
          buttonContainer.style.gap = '10px';
          buttonContainer.style.justifyContent = 'center';
          buttonContainer.style.flexWrap = 'wrap';

          // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™ãƒã‚§ãƒƒã‚¯ãƒœã‚¿ãƒ³
          const checkExpiryButton = document.createElement('button');
          checkExpiryButton.textContent = 'æœŸé™ãƒã‚§ãƒƒã‚¯';
          checkExpiryButton.style.padding = '8px 16px';
          checkExpiryButton.style.fontSize = '14px';
          checkExpiryButton.style.backgroundColor = '#28a745';
          checkExpiryButton.style.color = 'white';
          checkExpiryButton.style.border = 'none';
          checkExpiryButton.style.borderRadius = '4px';
          checkExpiryButton.style.cursor = 'pointer';
          checkExpiryButton.style.transition = 'background-color 0.3s ease';

          checkExpiryButton.addEventListener('mouseover', function() {
            this.style.backgroundColor = '#218838';
          });

          checkExpiryButton.addEventListener('mouseout', function() {
            this.style.backgroundColor = '#28a745';
          });

          checkExpiryButton.addEventListener('click', function() {
            showTokenExpiryStatus();
          });

          buttonContainer.appendChild(checkExpiryButton);

          // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
          if (data.refresh_token) {
            const refreshButton = document.createElement('button');
            refreshButton.textContent = 'ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆ';
            refreshButton.style.padding = '8px 16px';
            refreshButton.style.fontSize = '14px';
            refreshButton.style.backgroundColor = '#17a2b8';
            refreshButton.style.color = 'white';
            refreshButton.style.border = 'none';
            refreshButton.style.borderRadius = '4px';
            refreshButton.style.cursor = 'pointer';
            refreshButton.style.transition = 'background-color 0.3s ease';

            refreshButton.addEventListener('mouseover', function () {
              this.style.backgroundColor = '#138496';
            });

            refreshButton.addEventListener('mouseout', function () {
              this.style.backgroundColor = '#17a2b8';
            });

            refreshButton.addEventListener('click', function () {
              testRefreshToken(data.refresh_token);
            });

            buttonContainer.appendChild(refreshButton);
          }

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
          const userInfoButton = document.createElement('button');
          userInfoButton.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—';
          userInfoButton.style.padding = '8px 16px';
          userInfoButton.style.fontSize = '14px';
          userInfoButton.style.backgroundColor = '#6f42c1';
          userInfoButton.style.color = 'white';
          userInfoButton.style.border = 'none';
          userInfoButton.style.borderRadius = '4px';
          userInfoButton.style.cursor = 'pointer';
          userInfoButton.style.transition = 'background-color 0.3s ease';

          userInfoButton.addEventListener('mouseover', function () {
            this.style.backgroundColor = '#5a359a';
          });

          userInfoButton.addEventListener('mouseout', function () {
            this.style.backgroundColor = '#6f42c1';
          });

          userInfoButton.addEventListener('click', function () {
            fetchUserInfo();
          });

          buttonContainer.appendChild(userInfoButton);

          tokenInfo.appendChild(buttonContainer);
          document.querySelector('.container').appendChild(tokenInfo);
        } else {
          console.error('ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', data);
          showError('ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼', data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æ™‚ã«ä¾‹å¤–ãŒç™ºç”Ÿ:', error);
        showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹é–¢æ•°
    async function testRefreshToken(refreshToken) {
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦å‡¦ç†ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
      const refreshButton = event.target;
      let currentButton = refreshButton; // ç¾åœ¨ã®ãƒœã‚¿ãƒ³ã®å‚ç…§ã‚’ä¿æŒ

      try {
        console.log('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆé–‹å§‹:', refreshToken);

        currentButton.disabled = true;
        currentButton.textContent = 'ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ä¸­...';
        currentButton.style.backgroundColor = '#6c757d';

        const response = await fetch('http://localhost:3510/oauth/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            grant_type: 'refresh_token',
            refresh_token: refreshToken,
            client_id: 'demo_app'
          })
        });

        const data = await response.json();

        // çµæœã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ã‚’ä½œæˆ
        const refreshResult = document.createElement('div');
        refreshResult.style.marginTop = '15px';
        refreshResult.style.padding = '10px';
        refreshResult.style.borderRadius = '4px';

        if (response.ok) {
          console.log('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆæˆåŠŸ:', data);

          // æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã«ä¿å­˜
          saveTokensToStorage(data);

          refreshResult.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
          refreshResult.style.borderLeft = '4px solid #27ae60';
          refreshResult.style.color = '#27ae60';
          refreshResult.innerHTML = `
            <h4>ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆæˆåŠŸ!</h4>
            <pre style="overflow-x: auto; background: #eee; padding: 8px; border-radius: 4px; color: #333;">${JSON.stringify(data, null, 2)}</pre>
            <p style="margin: 5px 0; color: #333;">æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£å¸¸ã«å–å¾—ã•ã‚Œã¾ã—ãŸã€‚</p>
          `;

          // æ–°ã—ã„ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ›´æ–°
          if (data.refresh_token) {
            // æ—¢å­˜ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ 
            const newRefreshButton = currentButton.cloneNode(true);
            newRefreshButton.addEventListener('click', function () {
              testRefreshToken(data.refresh_token);
            });
            newRefreshButton.addEventListener('mouseover', function () {
              this.style.backgroundColor = '#138496';
            });
            newRefreshButton.addEventListener('mouseout', function () {
              this.style.backgroundColor = '#17a2b8';
            });

            // ãƒœã‚¿ãƒ³ã®è¦ªè¦ç´ ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ç½®ãæ›ãˆ
            if (currentButton.parentNode) {
              currentButton.parentNode.replaceChild(newRefreshButton, currentButton);
              currentButton = newRefreshButton; // æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚’ç¾åœ¨ã®ãƒœã‚¿ãƒ³ã¨ã—ã¦è¨­å®š
              console.log('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒœã‚¿ãƒ³ãŒæ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã§æ›´æ–°ã•ã‚Œã¾ã—ãŸ');
            }
          }
        } else {
          console.error('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', data);
          refreshResult.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
          refreshResult.style.borderLeft = '4px solid #e74c3c';
          refreshResult.style.color = '#e74c3c';
          refreshResult.innerHTML = `
            <h4>ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆå¤±æ•—</h4>
            <pre style="overflow-x: auto; background: #eee; padding: 8px; border-radius: 4px; color: #333;">${JSON.stringify(data, null, 2)}</pre>
            <p style="margin: 5px 0; color: #333;">ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
          `;
        }

        // æ—¢å­˜ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥çµæœãŒã‚ã‚Œã°å‰Šé™¤
        const existingResult = document.querySelector('[data-refresh-result]');
        if (existingResult) {
          existingResult.remove();
        }

        refreshResult.setAttribute('data-refresh-result', 'true');
        if (currentButton.parentElement && currentButton.parentElement.parentElement) {
          currentButton.parentElement.parentElement.appendChild(refreshResult);
        }

      } catch (error) {
        console.error('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆæ™‚ã«ä¾‹å¤–ãŒç™ºç”Ÿ:', error);

        const refreshResult = document.createElement('div');
        refreshResult.style.marginTop = '15px';
        refreshResult.style.padding = '10px';
        refreshResult.style.borderRadius = '4px';
        refreshResult.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
        refreshResult.style.borderLeft = '4px solid #e74c3c';
        refreshResult.style.color = '#e74c3c';
        refreshResult.innerHTML = `
          <h4>é€šä¿¡ã‚¨ãƒ©ãƒ¼</h4>
          <p style="color: #333;">ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>
        `;

        // æ—¢å­˜ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥çµæœãŒã‚ã‚Œã°å‰Šé™¤
        const existingResult = document.querySelector('[data-refresh-result]');
        if (existingResult) {
          existingResult.remove();
        }

        refreshResult.setAttribute('data-refresh-result', 'true');
        if (currentButton.parentElement && currentButton.parentElement.parentElement) {
          currentButton.parentElement.parentElement.appendChild(refreshResult);
        }

      } finally {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        if (currentButton) {
          currentButton.disabled = false;
          currentButton.textContent = 'ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆ';
          currentButton.style.backgroundColor = '#17a2b8';
        }
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    async function fetchUserInfo() {
      try {
        // LocalStorageã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const accessToken = localStorage.getItem('access_token');

        if (!accessToken) {
          showError('èªè¨¼ã‚¨ãƒ©ãƒ¼', 'ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—é–‹å§‹');

        const response = await fetch('http://localhost:3510/oauth/userinfo', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        // çµæœã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ã‚’ä½œæˆ
        const userInfoResult = document.createElement('div');
        userInfoResult.style.marginTop = '15px';
        userInfoResult.style.padding = '10px';
        userInfoResult.style.borderRadius = '4px';

        if (response.ok) {
          console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—æˆåŠŸ:', data);

          userInfoResult.style.backgroundColor = 'rgba(111, 66, 193, 0.1)';
          userInfoResult.style.borderLeft = '4px solid #6f42c1';
          userInfoResult.style.color = '#6f42c1';
          userInfoResult.innerHTML = `
            <h4>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—æˆåŠŸ!</h4>
            <pre style="overflow-x: auto; background: #eee; padding: 8px; border-radius: 4px; color: #333;">${JSON.stringify(data, null, 2)}</pre>
            <p style="margin: 5px 0; color: #333;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæ­£å¸¸ã«å–å¾—ã•ã‚Œã¾ã—ãŸã€‚</p>
          `;
        } else {
          console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', data);

          userInfoResult.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
          userInfoResult.style.borderLeft = '4px solid #e74c3c';
          userInfoResult.style.color = '#e74c3c';

          let errorMessage = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
          if (response.status === 401) {
            errorMessage = 'ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚';
          } else if (response.status === 403) {
            errorMessage = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
          }

          userInfoResult.innerHTML = `
            <h4>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—å¤±æ•—</h4>
            <pre style="overflow-x: auto; background: #eee; padding: 8px; border-radius: 4px; color: #333;">${JSON.stringify(data, null, 2)}</pre>
            <p style="margin: 5px 0; color: #333;">${errorMessage}</p>
          `;
        }

        // æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±çµæœãŒã‚ã‚Œã°å‰Šé™¤
        const existingResult = document.querySelector('[data-userinfo-result]');
        if (existingResult) {
          existingResult.remove();
        }

        userInfoResult.setAttribute('data-userinfo-result', 'true');

        // ãƒœã‚¿ãƒ³ã®è¦ªè¦ç´ ã®è¦ªè¦ç´ ã«çµæœã‚’è¿½åŠ 
        const buttonContainer = document.querySelector('.container > div:last-child');
        if (buttonContainer) {
          buttonContainer.appendChild(userInfoResult);
        }

      } catch (error) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—æ™‚ã«ä¾‹å¤–ãŒç™ºç”Ÿ:', error);

        const userInfoResult = document.createElement('div');
        userInfoResult.style.marginTop = '15px';
        userInfoResult.style.padding = '10px';
        userInfoResult.style.borderRadius = '4px';
        userInfoResult.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
        userInfoResult.style.borderLeft = '4px solid #e74c3c';
        userInfoResult.style.color = '#e74c3c';
        userInfoResult.innerHTML = `
          <h4>é€šä¿¡ã‚¨ãƒ©ãƒ¼</h4>
          <p style="color: #333;">ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>
        `;

        // æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±çµæœãŒã‚ã‚Œã°å‰Šé™¤
        const existingResult = document.querySelector('[data-userinfo-result]');
        if (existingResult) {
          existingResult.remove();
        }

        userInfoResult.setAttribute('data-userinfo-result', 'true');

        const buttonContainer = document.querySelector('.container > div:last-child');
        if (buttonContainer) {
          buttonContainer.appendChild(userInfoResult);
        }
      }
    }

    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‡¦ç†
    document.getElementById('redirect-login').addEventListener('click', function () {
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('error-message').style.display = 'none';

      // ä»¥å‰ã®èªè¨¼çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
      const previousAuthMessage = document.getElementById('auth-success-message');
      if (previousAuthMessage) {
        previousAuthMessage.remove();
      }

      // çŠ¶æ…‹ã‚’è¡¨ç¤º
      const statusMessage = document.createElement('div');
      statusMessage.textContent = 'èªè¨¼ã‚’é–‹å§‹ã—ã¾ã™...';
      statusMessage.style.margin = '10px 0';
      statusMessage.style.padding = '10px';
      statusMessage.style.backgroundColor = '#fcf8e3';
      statusMessage.style.borderRadius = '4px';
      document.querySelector('.container').appendChild(statusMessage);

      // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªçŠ¶æ…‹è­˜åˆ¥å­ã‚’ç”Ÿæˆï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã«æ¤œè¨¼ã™ã‚‹ãŸã‚ï¼‰
      const state = Date.now().toString(36) + Math.random().toString(36).substr(2);

      // ç›´æ¥èªè¨¼ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆstateã¨displayãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼‰
      // window.location.href ã‚’ä½¿ç”¨ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã®å±¥æ­´ã«æ®‹ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒä½¿ãˆã‚‹ï¼‰
      const redirectUri = window.location.origin + window.location.pathname;
      window.location.href = `http://localhost:3510/login.html?client_id=demo_app&redirect_uri=${encodeURIComponent(redirectUri)}&state=${state}&display=redirect`;
    });
  </script>
</body>

</html>
