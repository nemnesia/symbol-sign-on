<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Symbol Sign Auth - Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background: #0056b3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    input,
    textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .response {
      background: #e7f3ff;
      padding: 10px;
      border-radius: 4px;
      border-left: 4px solid #007bff;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
    }

    .error {
      background: #ffe7e7;
      border-left-color: #dc3545;
    }

    .success {
      background: #d4edda;
      border-left-color: #28a745;
    }

    .step {
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .step h3 {
      margin-top: 0;
      color: #333;
    }

    .oauth-flow {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border: 1px solid #ddd;
    }

    .current-step {
      background: #e7f3ff;
      border-left: 4px solid #007bff;
    }

    .iframe-container {
      margin: 20px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }

    iframe {
      width: 100%;
      height: 400px;
      border: none;
    }
  </style>
</head>

<body>
  <h1>Symbol Sign Auth - OAuth2 Demo</h1>
  <p>このデモページでは、OAuth2準拠のSymbol署名認証フローをテストできます。</p>

  <div class="oauth-flow">
    <h3>OAuth2フローの概要</h3>
    <ol>
      <li><strong>認可リクエスト</strong>: OAuth2認可エンドポイントをポップアップで表示</li>
      <li><strong>認可画面</strong>: ユーザーが認可/拒否を選択</li>
      <li><strong>署名検証</strong>: 署名済みトランザクションで認証</li>
      <li><strong>認可コード取得</strong>: 認可コードがpostMessageで返される</li>
      <li><strong>トークン交換</strong>: 認可コードをアクセストークンに交換</li>
      <li><strong>リソースアクセス</strong>: アクセストークンでAPIを呼び出し</li>
    </ol>
    <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 0.9em;">
      <strong>ポップアップモード:</strong> シングルサインオンの使用感を向上させるため、認可画面はポップアップウィンドウで表示されます。
    </div>
  </div>

  <div class="step current-step" id="step1">
    <h3>Step 1: OAuth2認可フロー開始</h3>
    <label>Client ID:</label>
    <input type="text" id="clientId" value="demo-client" placeholder="クライアントID"><br>

    <label>Redirect URI:</label>
    <input type="text" id="redirectUri" value="http://localhost:3510/demo.html" placeholder="リダイレクトURI"><br>

    <button onclick="startOAuthFlow()">OAuth2認可フローを開始</button>
    <div id="oauthResponse"></div>
  </div>

  <div class="step" id="step2" style="display: none;">
    <h3>Step 2: 認可コードを受信</h3>
    <p>認可が完了すると、認可コードがURLパラメータとして返されます。</p>
    <label>認可コード:</label>
    <input type="text" id="authCode" readonly><br>

    <label>State:</label>
    <input type="text" id="state" readonly><br>

    <button onclick="exchangeToken()" id="tokenBtn" disabled>アクセストークンを取得</button>
    <div id="tokenResponse"></div>
  </div>

  <div class="step" id="step3" style="display: none;">
    <h3>Step 3: ユーザー情報取得</h3>
    <label>Access Token:</label>
    <input type="text" id="accessToken" readonly><br>

    <button onclick="getUserInfo()" id="userInfoBtn" disabled>ユーザー情報を取得</button>
    <div id="userInfoResponse"></div>
  </div>

  <div class="step" id="step4" style="display: none;">
    <h3>Step 4: 署名検証（開発用）</h3>
    <p>認可画面で「認可する」を選択した後、ここで署名検証を行います。</p>
    <label>チャレンジ ID:</label>
    <input type="text" id="challengeId" placeholder="認可画面で表示されたチャレンジID"><br>

    <label>署名済みトランザクション:</label>
    <textarea id="signedTx" rows="4" placeholder="署名済みトランザクション（16進数）"></textarea><br>

    <button onclick="verifySignature()">署名を検証</button>
    <div id="verifyResponse"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3510';

    // ページ読み込み時にURLパラメータをチェック
    window.onload = function () {
      // ポップアップモードでは親ウィンドウからのメッセージで処理するため、
      // URLパラメータチェックは非ポップアップ時のみ実行
      if (window.opener) {
        return; // ポップアップ内では何もしない
      }

      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');

      if (error) {
        displayError('oauthResponse', `OAuth2エラー: ${error} - ${urlParams.get('error_description') || 'Unknown error'}`);
        return;
      }

      if (code) {
        // 認可コードを受信
        document.getElementById('authCode').value = code;
        document.getElementById('state').value = state || '';

        // Step 2を表示
        showStep(2);
        document.getElementById('tokenBtn').disabled = false;

        displaySuccess('oauthResponse', `認可コードを受信しました: ${code}`);
      }
    };

    function showStep(stepNumber) {
      // 全てのステップを非表示
      for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        step.style.display = 'none';
        step.classList.remove('current-step');
      }

      // 指定されたステップを表示
      const currentStep = document.getElementById(`step${stepNumber}`);
      currentStep.style.display = 'block';
      currentStep.classList.add('current-step');
    }

    function displaySuccess(elementId, message) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="response success">${message}</div>`;
    }

    function displayError(elementId, message) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="response error">${message}</div>`;
    }

    function displayResponse(elementId, response) {
      const element = document.getElementById(elementId);
      if (response.success) {
        element.innerHTML = `<div class="response">${JSON.stringify(response.data, null, 2)}</div>`;
      } else {
        element.innerHTML = `<div class="response error">Error: ${response.error || response.data?.error || 'Unknown error'}</div>`;
      }
    }

    async function apiCall(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });

        const data = await response.json();
        return { success: response.ok, data, status: response.status };
      } catch (error) {
        return { success: false, error: error.message };
      }
    }

    function startOAuthFlow() {
      const clientId = document.getElementById('clientId').value.trim();
      const redirectUri = document.getElementById('redirectUri').value.trim();

      if (!clientId || !redirectUri) {
        displayError('oauthResponse', 'Client ID、Redirect URIは必須です');
        return;
      }

      // OAuth2認可エンドポイントにポップアップで表示
      const params = new URLSearchParams({
        response_type: 'code',
        client_id: clientId,
        redirect_uri: redirectUri,
        popup: 'true'  // ポップアップリクエストであることを明示
      });

      const authUrl = `${API_BASE}/oauth/authorize?${params.toString()}`;
      displaySuccess('oauthResponse', `認可ポップアップを開きます: ${authUrl}`);

      // ポップアップウィンドウで認可画面を表示
      const popup = window.open(
        authUrl,
        'oauth_popup',
        'width=600,height=700,scrollbars=yes,resizable=yes,left=' +
        (screen.width / 2 - 300) + ',top=' + (screen.height / 2 - 350)
      );

      // ポップアップが正常に開かれたかチェック
      if (!popup) {
        displayError('oauthResponse', 'ポップアップがブロックされました。ポップアップブロッカーを無効にしてください。');
        return;
      }      // ポップアップにフォーカスを当てる
      try {
        popup.focus();
      } catch (e) {
        console.warn('Could not focus popup:', e);
      }

      // メッセージハンドラーを先に定義
      let checkClosed;
      const messageHandler = function(event) {
        console.log('Message received in demo.html:', event);

        // オリジンチェック
        if (event.origin !== API_BASE) {
          console.log('Ignoring message from wrong origin:', event.origin);
          return;
        }

        // データが存在し、有効なOAuth2レスポンスかチェック
        if (!event.data || (typeof event.data !== 'object')) {
          console.log('Ignoring message with invalid data:', event.data);
          return;
        }

        // OAuth2固有のデータが含まれているかチェック
        if (!event.data.code && !event.data.error) {
          console.log('Ignoring message without OAuth2 data:', event.data);
          return;
        }

        console.log('Processing valid OAuth2 message:', event.data);

        // リスナーとタイマーをクリーンアップ
        if (checkClosed) {
          clearInterval(checkClosed);
        }
        window.removeEventListener('message', messageHandler);

        // ポップアップを閉じる
        if (popup && !popup.closed) {
          popup.close();
        }

        if (event.data.error) {
          displayError('oauthResponse', `OAuth2エラー: ${event.data.error} - ${event.data.error_description || 'Unknown error'}`);
          return;
        }

        if (event.data.code) {
          // 認可コードを受信
          document.getElementById('authCode').value = event.data.code;
          document.getElementById('state').value = event.data.state || '';

          // Step 2を表示
          showStep(2);
          document.getElementById('tokenBtn').disabled = false;

          displaySuccess('oauthResponse', `認可コードを受信しました: ${event.data.code}`);
        }
      };

      // ポップアップの監視
      checkClosed = setInterval(() => {
        if (popup.closed) {
          clearInterval(checkClosed);
          // メッセージリスナーをクリーンアップ
          window.removeEventListener('message', messageHandler);
          displayError('oauthResponse', 'ポップアップが閉じられました。認可がキャンセルされた可能性があります。');
        }
      }, 1000);

      // ポップアップからのメッセージを受信
      window.addEventListener('message', messageHandler);
    }

    async function exchangeToken() {
      const code = document.getElementById('authCode').value;
      const clientId = document.getElementById('clientId').value;

      const response = await apiCall('/oauth/token', {
        method: 'POST',
        body: JSON.stringify({
          grant_type: 'authorization_code',
          code: code,
          client_id: clientId
        })
      });

      displayResponse('tokenResponse', response);

      if (response.success) {
        document.getElementById('accessToken').value = response.data.access_token;
        document.getElementById('userInfoBtn').disabled = false;
        showStep(3);
      }
    }

    async function getUserInfo() {
      const token = document.getElementById('accessToken').value;

      const response = await apiCall('/oauth/userinfo', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      displayResponse('userInfoResponse', response);

      if (response.success) {
        showStep(4);
      }
    }

    async function verifySignature() {
      const signedTx = document.getElementById('signedTx').value.trim();

      if (!signedTx) {
        displayError('verifyResponse', '署名済みトランザクションを入力してください');
        return;
      }

      const response = await apiCall('/oauth/verify-signature', {
        method: 'PUT',
        body: JSON.stringify({ payload: signedTx })
      });

      displayResponse('verifyResponse', response);
    }
  </script>
</body>

</html>
